<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge" />
    <meta name="viewport" content="width=device-width, initial-scale=1" />
    <style>
      input {
        display: block;
        clear: both;
        margin: 10px 0;
      }
    </style>
  </head>

  <body>
    <h2>Planet Metadata Uploader</h2>

    <label for="baseUri">baseUri :</label>
    <input id="baseUri" autocomplete="off" value="http://localhost:3001/" />

    <label for="tokenId">TokenId :</label>
    <input id="tokenId" autocomplete="off" value="1" />

    <label for="name">Name :</label>
    <input id="name" autocomplete="off" value="jupiter #1" />

    <label for="description">Description :</label>
    <input
      id="description"
      autocomplete="off"
      value="Jupiter is the fifth planet from the Sun and the largest in the Solar System. "
    />

    <label for="attributes">Traits :</label><br />
    <textarea id="attributes" autocomplete="off" style="width: 170px" rows="5">
[{"trait_type": "rarity","value": "normal"}]</textarea
    ><br />

    <label for="image">Image :</label>
    <input type="file" id="image" accept="image/*" />

    <button onclick="onSubmit();">submit</button>
    <div id="tokenURIs"></div>

    <div id="result"></div>

    <script>
      async function onSubmit() {
        try {
          const { baseUri, tokenId, name, description, attributes } =
            validateAndGetValue();

          const imageInput = document.getElementById("image");
          if (!imageInput.files[0]) {
            throw new Error("please select image to upload");
          }
          const formData = new FormData();
          formData.append("image", imageInput.files[0]);
          formData.append("baseUri", baseUri);
          formData.append("tokenId", tokenId);
          formData.append("name", name);
          formData.append("description", description);
          formData.append("attributes", attributes);
          const res = await postFormData(`${baseUri}metadata`, formData);

          const metadataUrl = `${baseUri}metadata/${tokenId}`;
          document.getElementById(
            "result"
          ).innerHTML = `<p>upload success!, please visit <a target="_blank" href="${metadataUrl}">${metadataUrl}</a></p>`;
        } catch (e) {
          console.log(e);
          alert(e.message);
        }
      }

      function validateAndGetValue() {
        const baseUri = document.getElementById("baseUri").value;
        if (!baseUri) {
          throw new Error("please fill in the `baseUri`");
        }
        const tokenId = document.getElementById("tokenId").value;
        if (!tokenId) {
          throw new Error("please fill in the `tokenId`");
        }
        const name = document.getElementById("name").value;
        if (!name) {
          throw new Error("please fill in the `name`");
        }
        const description = document.getElementById("description").value;
        if (!description) {
          throw new Error("please fill in the `description`");
        }
        let attributes = document.getElementById("attributes").value;
        if (attributes) {
          try {
            JSON.parse(attributes);
          } catch (e) {
            throw new Error("`attributes` cannot be convert to JSON");
          }
        } else {
          attributes = "[]";
        }

        return { baseUri, tokenId, name, description, attributes };
      }

      async function postFormData(url = "", formdata) {
        const response = await fetch(url, {
          method: "POST",
          mode: "cors",
          cache: "no-cache",
          credentials: "same-origin",
          redirect: "follow",
          referrerPolicy: "no-referrer",
          body: formdata,
        });
        return response.json();
      }

      // 获取填写数据
      //     const name = document.getElementById("demo-name").value;
      //     const description = document.getElementById("demo-des").value;
      //     const fileContent = document.getElementById("demo-image").files[0];
      //     if (!name || !description || !fileContent) {
      //       alert("please input ERC721 info!");
      //       return;
      //     }

      //     // 上传图片至 ipfs
      //     const imageResults = await node.add(fileContent);
      //     const imgUrl = `${basePath}/${imageResults.path}`;
      //     const metadata = {
      //       description,
      //       name,
      //       image: imgUrl,
      //     };

      //     // 上传 matedata
      //     const metadataResults = await node.add(JSON.stringify(metadata));
      //     // 创建元素并添加至 dom 节点中
      //     const tokenURIItemDom = document.createElement("a");
      //     const metadataResultsPath = `${basePath}${metadataResults.path}`;
      //     tokenURIItemDom.innerText = metadataResults.path;
      //     tokenURIItemDom.href = metadataResultsPath;
      //     tokenURIItemDom.target = "_blank";
      //     tokenURIItemDom.id = "url";
      //     const copyButton = document.createElement("button");
      //     copyButton.id = "copy";
      //     copyButton.innerText = "copy";
      //     document.getElementById("tokenURIs").innerHTML = "";
      //     document
      //       .getElementById("tokenURIs")
      //       .append(tokenURIItemDom, copyButton);
      //     document.getElementById("copy").addEventListener("click", () => {
      //       selectText("url");
      //     });
      //   }

      //   function selectText(element) {
      //     const text = document.getElementById(element);
      //     if (document.body.createTextRange) {
      //       const range = document.body.createTextRange();
      //       range.moveToElementText(text);
      //       range.select();
      //     } else if (window.getSelection) {
      //       const selection = window.getSelection();
      //       const range = document.createRange();
      //       range.selectNodeContents(text);
      //       selection.removeAllRanges();
      //       selection.addRange(range);
      //       document.execCommand("Copy");
      //     } else {
      //       alert("none");
      //     }
      //   }
    </script>
  </body>
</html>
